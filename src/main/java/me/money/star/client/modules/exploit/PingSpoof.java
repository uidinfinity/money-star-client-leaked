package me.money.star.client.modules.exploit;

import com.google.common.eventbus.Subscribe;
import me.money.star.client.gui.modules.Module;
import me.money.star.client.settings.Setting;

import me.money.star.event.impl.PacketEvent;
import net.minecraft.network.packet.c2s.common.KeepAliveC2SPacket;
import net.minecraft.network.packet.s2c.common.KeepAliveS2CPacket;

import java.util.concurrent.ConcurrentLinkedQueue;

public class PingSpoof extends Module {
    public Setting<Integer> delay = num("Delay", 10, 1, 2000);

    public PingSpoof() {
        super("PingSpoof", "Allows you to mine and use items simultaneously", Category.EXPLOIT,true,false,false);
    }
    private final ConcurrentLinkedQueue<DelayedPacket> queue = new ConcurrentLinkedQueue<>();

    @Subscribe
    public void onPacketReceive(PacketEvent.Receive event) {
        if (fullNullCheck())return;
        if (event.getPacket() instanceof KeepAliveS2CPacket packet) {
            event.setCancelled(true);
            queue.add(new DelayedPacket(packet, System.currentTimeMillis()));
        }
    }

    @Override
    public void onUpdate() {
        if (fullNullCheck()) return;

        DelayedPacket packet = queue.peek();
        if (packet == null) return;

        if (System.currentTimeMillis() - packet.time() >= delay.getValue().intValue()) {
            sendPacket(new KeepAliveC2SPacket(queue.poll().packet().getId()));
        }
    }
    private record DelayedPacket(KeepAliveS2CPacket packet, long time) {}
}
